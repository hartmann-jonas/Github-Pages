<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<link rel="icon" href="../favicon.png" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<meta http-equiv="content-security-policy" content="">
		<link href="../_app/immutable/assets/_layout-8003c18b.css" rel="stylesheet">
		<link href="../_app/immutable/assets/_page-d97f4a66.css" rel="stylesheet">
		<link rel="modulepreload" href="../_app/immutable/start-aca0e6ba.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/index-b0905f39.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/singletons-4e3a929d.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/index-4b71bf5b.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/preload-helper-41c905a7.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/control-e7f5239e.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/parse-b67c4dc9.js">
		<link rel="modulepreload" href="../_app/immutable/components/layout.svelte-afe953a1.js">
		<link rel="modulepreload" href="../_app/immutable/modules/pages/_layout.ts-9cbb603b.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/_layout-da46b06b.js">
		<link rel="modulepreload" href="../_app/immutable/components/pages/blog/_layout.svelte-3bb0ca78.js">
		<link rel="modulepreload" href="../_app/immutable/components/pages/blog/_path_/_page.svelte-408e1e2a.js">
		<link rel="modulepreload" href="../_app/immutable/modules/pages/blog/_path_/_page.js-17edcf96.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/_page-97511be2.js"><!-- HEAD_svelte-3vh2vb_START --><link rel="stylesheet" href="/pico.min.css"><style>nav {
        margin-left: 10%;
        margin-right: 10%;
      }
    </style><!-- HEAD_svelte-3vh2vb_END -->
	</head>
	<body>
		<div>



  
  <main class="container"><nav><ul><li><a href="/">Maja Webutveckling 2</a></li>
        <li><a href="/clicker">Clicker</a></li>
        <li><a href="/todo">Todo-List</a></li>
        <li><a href="/eliza">ElizaBot</a></li>
        <li><a href="/memory">Memory</a></li>
        <li><a href="/search">API Search</a></li>
        <li><a href="/blog">Blog</a></li></ul></nav>
    

  
<article class="svelte-1viwzin"><div class="head svelte-1viwzin"><h1 class="svelte-1viwzin">Version 0.0.2</h1>
        <p class="svelte-1viwzin">Last updated: 2023-04-17</p></div>
    <div class="article svelte-1viwzin"><h1>Login</h1>
<h2>Description</h2>
<p>After having a good starting point and some inspiration I worked on some login functionality on the website. That way every different user could have the website presented to him in a different way. This <a href="https://youtu.be/E3VG-dLCRUk" rel="nofollow">tutorial</a> by Joy of Code was recommended to me on how to implement this functionality using cookies and a prisma database. I used this starting point to get familiar with prisma and databases in general.</p>
<h2>Changes</h2>
<p>The following changes and implementations have been made in that version of the project:</p>
<ul><li>Installed <a href="https://prisma.io" rel="nofollow">Prisma</a> and created a client with a SQLite database.</li>
<li>When user is logged in a cookie is created that saves the current session for 30 days</li>
<li>Use <a href="https://kit.svelte.dev/docs/hooks" rel="nofollow">SvelteKit Hooks</a> to store the session for checking if the user is logged in</li></ul>
<p>To get a better view on how the login functionality works, watch the <a href="https://youtu.be/E3VG-dLCRUk" rel="nofollow">tutorial</a>.</p>
<h2>Features</h2>
<p>‚úÖ Login/Register üßë‚Äçüíª  </p>
<h2>Code</h2>
<p>In here some selected code will be explained more in depth.</p>
<p>schema.prisma file to structure the database</p>
<pre class="language-ts"><!-- HTML_TAG_START --><code class="language-ts"><span class="token comment">// define database provider that we use</span>
datasource db <span class="token punctuation">&#123;</span>
    provider <span class="token operator">=</span> <span class="token string">"sqlite"</span>
    <span class="token comment">// url is stored in .env file so that users cant see the url</span>
    url      <span class="token operator">=</span> <span class="token function">env</span><span class="token punctuation">(</span><span class="token string">"DATABASE_URL"</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// define the database tabels referred to as models</span>
model User <span class="token punctuation">&#123;</span>
    <span class="token comment">// unique individual id for each user</span>
    id              String <span class="token decorator"><span class="token at operator">@</span><span class="token function">id</span></span> <span class="token decorator"><span class="token at operator">@</span><span class="token function">unique</span></span> @<span class="token keyword">default</span><span class="token punctuation">(</span><span class="token function">uuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// no username can be taken twice</span>
    username        String <span class="token decorator"><span class="token at operator">@</span><span class="token function">unique</span></span>
    <span class="token comment">// hash of the password to not store a clear password</span>
    passwordHash    String
    <span class="token comment">// unique token used for the cookie</span>
    userAuthToken   String <span class="token decorator"><span class="token at operator">@</span><span class="token function">unique</span></span>

    createdAt   DateTime @<span class="token keyword">default</span><span class="token punctuation">(</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    updatedAt   DateTime <span class="token decorator"><span class="token at operator">@</span><span class="token function">updatedAt</span></span>
    <span class="token comment">// assign a role to the user used to seperate users and admins</span>
    <span class="token comment">// using prisma relations to reference the Roles model</span>
    <span class="token comment">// pointing to the id in the Roles model</span>
    role        Roles   <span class="token decorator"><span class="token at operator">@</span><span class="token function">relation</span></span><span class="token punctuation">(</span>fields<span class="token operator">:</span> <span class="token punctuation">[</span>roleId<span class="token punctuation">]</span><span class="token punctuation">,</span> references<span class="token operator">:</span> <span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">)</span>
    roleId      Int
<span class="token punctuation">&#125;</span>

model Roles <span class="token punctuation">&#123;</span>
  id   Int    <span class="token decorator"><span class="token at operator">@</span><span class="token function">id</span></span> @<span class="token keyword">default</span><span class="token punctuation">(</span><span class="token function">autoincrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  name String <span class="token decorator"><span class="token at operator">@</span><span class="token function">unique</span></span>
  User User<span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span></code><!-- HTML_TAG_END --></pre>
<p>login/+page.server.ts to handle the login process</p>
<pre class="language-ts"><!-- HTML_TAG_START --><code class="language-ts"><span class="token comment">// function to redirect users that are logged away from the login page</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> load<span class="token operator">:</span> <span class="token function-variable function">PageServerLoad</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">&#123;</span> locals <span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// redirect user if logged in</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>locals<span class="token punctuation">.</span>user<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">throw</span> <span class="token function">redirect</span><span class="token punctuation">(</span><span class="token number">302</span><span class="token punctuation">,</span> <span class="token string">'/'</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// first we request the username and password from the html form</span>
<span class="token keyword">const</span> username <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> password <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'password'</span><span class="token punctuation">)</span>

<span class="token comment">// check if somebody trys to bamboozle us</span>
<span class="token comment">// if a username/password is not a string or nonexistent fail</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>
    <span class="token keyword">typeof</span> username <span class="token operator">!==</span> <span class="token string">'string'</span> <span class="token operator">||</span>
    <span class="token keyword">typeof</span> password <span class="token operator">!==</span> <span class="token string">'string'</span> <span class="token operator">||</span>
    <span class="token operator">!</span>username <span class="token operator">||</span>
    <span class="token operator">!</span>password
<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token function">fail</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> invalid<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// if that worked we request the user from the database</span>
<span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> database<span class="token punctuation">.</span>user<span class="token punctuation">.</span><span class="token function">findUnique</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> where<span class="token operator">:</span> <span class="token punctuation">&#123;</span> username <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

<span class="token comment">// now we also need to import the database on the top</span>
<span class="token keyword">import</span> <span class="token punctuation">&#123;</span> database <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'$lib/database'</span>

<span class="token comment">// now we compare the password entered and the password from the database</span>
<span class="token keyword">const</span> userPassword <span class="token operator">=</span> <span class="token keyword">await</span> bcrypt<span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span> user<span class="token punctuation">.</span>passwordHash<span class="token punctuation">)</span>

<span class="token comment">// if that fails we return fail and say wrong credentials</span>
<span class="token keyword">return</span> <span class="token function">fail</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>credentials<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

<span class="token comment">// if everything went well so far</span>
<span class="token comment">// we create a new authentification token in the database</span>
<span class="token keyword">const</span> authenticatedUser <span class="token operator">=</span> <span class="token keyword">await</span> database<span class="token punctuation">.</span>user<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
    where<span class="token operator">:</span> <span class="token punctuation">&#123;</span> username<span class="token operator">:</span> user<span class="token punctuation">.</span>username <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    data<span class="token operator">:</span> <span class="token punctuation">&#123;</span> userAuthToken<span class="token operator">:</span> crypto<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

<span class="token comment">// set the cookie to keep the user logged in for one moth</span>
cookies<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'session'</span><span class="token punctuation">,</span> authenticatedUser<span class="token punctuation">.</span>userAuthToken<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// send cookie for every page</span>
    path<span class="token operator">:</span> <span class="token string">'/'</span><span class="token punctuation">,</span>
    <span class="token comment">// server side only cookie so you can't use &#96;document.cookie&#96;</span>
    httpOnly<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token comment">// only requests from same site can send cookies</span>
    <span class="token comment">// https://developer.mozilla.org/en-US/docs/Glossary/CSRF</span>
    sameSite<span class="token operator">:</span> <span class="token string">'strict'</span><span class="token punctuation">,</span>
    <span class="token comment">// only sent over HTTPS in production</span>
    secure<span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">'production'</span><span class="token punctuation">,</span>
    <span class="token comment">// set cookie to expire after a month</span>
    maxAge<span class="token operator">:</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">24</span> <span class="token operator">*</span> <span class="token number">30</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
</code><!-- HTML_TAG_END --></pre>
<hr>
<br>
Commit: <a href="https://github.com/hartmann-jonas/movie-db-two/commit/c2b56d39d412752416717362c337289abdf3c189" target="_blank">Version 0.0.2</a>
<p>Published: 2023-04-03</p></div>
</article></main>


		<script type="module" data-sveltekit-hydrate="zpzbfi">
			import { start } from "../_app/immutable/start-aca0e6ba.js";

			start({
				env: {},
				paths: {"assets":"","base":""},
				target: document.querySelector('[data-sveltekit-hydrate="zpzbfi"]').parentNode,
				version: "1681738644203",
				hydrate: {
					node_ids: [0, 2, 7],
					data: [null,null,null],
					form: null,
					error: null
				}
			});
		</script>
	</div>
	</body>
	<style>
		body {
			margin: 0;
			padding: 0;
		}
	</style>
</html>

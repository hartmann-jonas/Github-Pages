<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<link rel="icon" href="../favicon.png" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<meta http-equiv="content-security-policy" content="">
		<link href="../_app/immutable/assets/_layout-8003c18b.css" rel="stylesheet">
		<link href="../_app/immutable/assets/_page-d97f4a66.css" rel="stylesheet">
		<link rel="modulepreload" href="../_app/immutable/start-aca0e6ba.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/index-b0905f39.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/singletons-4e3a929d.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/index-4b71bf5b.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/preload-helper-41c905a7.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/control-e7f5239e.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/parse-b67c4dc9.js">
		<link rel="modulepreload" href="../_app/immutable/components/layout.svelte-afe953a1.js">
		<link rel="modulepreload" href="../_app/immutable/modules/pages/_layout.ts-9cbb603b.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/_layout-da46b06b.js">
		<link rel="modulepreload" href="../_app/immutable/components/pages/blog/_layout.svelte-3bb0ca78.js">
		<link rel="modulepreload" href="../_app/immutable/components/pages/blog/_path_/_page.svelte-408e1e2a.js">
		<link rel="modulepreload" href="../_app/immutable/modules/pages/blog/_path_/_page.js-17edcf96.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/_page-97511be2.js"><!-- HEAD_svelte-3vh2vb_START --><link rel="stylesheet" href="/pico.min.css"><style>nav {
        margin-left: 10%;
        margin-right: 10%;
      }
    </style><!-- HEAD_svelte-3vh2vb_END -->
	</head>
	<body>
		<div>



  
  <main class="container"><nav><ul><li><a href="/">Maja Webutveckling 2</a></li>
        <li><a href="/clicker">Clicker</a></li>
        <li><a href="/todo">Todo-List</a></li>
        <li><a href="/eliza">ElizaBot</a></li>
        <li><a href="/memory">Memory</a></li>
        <li><a href="/search">API Search</a></li>
        <li><a href="/blog">Blog</a></li></ul></nav>
    

  
<article class="svelte-1viwzin"><div class="head svelte-1viwzin"><h1 class="svelte-1viwzin">Version 0.2.0</h1>
        <p class="svelte-1viwzin">Last updated: 2023-04-17</p></div>
    <div class="article svelte-1viwzin"><h1>Recommendations</h1>
<h2>Description</h2>
<p>In Version 0.2.0 personal recommendations are added, the user will get individualized recommendations for him based on his own interests. You can find them on the profile/recommended path!</p>
<h2>Changes</h2>
<p>The following changes and implementations have been made in that version of the project:</p>
<ul><li>Big changes to the database<ul><li>New model ‚ÄúKeywords‚Äù</li>
<li>If a movie gets liked, the keywords are added to the movie</li></ul></li></ul>
<p>How do we get the recommended movies?</p>
<ul><li>When visiting the page, all keywords are queried that the user liked</li>
<li>From those keywords, the top 3 keywords are evaluated based on frequency</li>
<li>With these keywords an API request is sent to TheMovieDB which returns movies with these keywords</li>
<li>From the response, the movies that the user has liked are filtered out</li></ul>
<h2>Features</h2>
<p>‚úÖ Individualized recommendations ‚ú®üéÅ </p>
<h2>Code</h2>
<p>In order to include the recommendations we needed some big changes under the hood.<br>
Here are some of them.</p>
<p>schema.prisma</p>
<pre class="language-ts"><!-- HTML_TAG_START --><code class="language-ts"><span class="token comment">// create a new model keywords that holds all of the keywords</span>
<span class="token comment">// with their id and connect them to movies that have that keyword</span>
model Keywords <span class="token punctuation">&#123;</span>
    id      Int     <span class="token decorator"><span class="token at operator">@</span><span class="token function">id</span></span> <span class="token decorator"><span class="token at operator">@</span><span class="token function">unique</span></span> @<span class="token keyword">default</span><span class="token punctuation">(</span><span class="token function">autoincrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    keyword String
    movie   Movie<span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// connect the Keyword model to the Movie model</span>
model Movie <span class="token punctuation">&#123;</span>
    <span class="token punctuation">[</span><span class="token operator">...</span><span class="token punctuation">]</span>
    keywords    Keywords<span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span></code><!-- HTML_TAG_END --></pre>
<p>profile/recommended/+page.server.ts</p>
<pre class="language-ts"><!-- HTML_TAG_START --><code class="language-ts"><span class="token comment">// first we query the keywords a user has liked like the following</span>
<span class="token keyword">const</span> movies <span class="token operator">=</span> <span class="token keyword">await</span> database<span class="token punctuation">.</span>movie<span class="token punctuation">.</span><span class="token function">findMany</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
    where<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        likes<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
            some<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
                id<span class="token operator">:</span> userId
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    include<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        keywords<span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// push the ids of the keywords into the keywords array</span>
movies<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>movie <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    movie<span class="token punctuation">.</span>keywors<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>keyword <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        keywords<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>keyword<span class="token punctuation">.</span>id<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// this part sorts the pushes the keywords into the keywordsList</span>

keywords<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>keyword<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">let</span> existing <span class="token operator">=</span> genresList<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span> <span class="token operator">=></span> r<span class="token punctuation">.</span>id <span class="token operator">===</span> keyword<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>existing<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	    existing<span class="token punctuation">.</span>occurrences<span class="token operator">++</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
	    keywordsList<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> id<span class="token operator">:</span> keyword<span class="token punctuation">,</span> occurrences<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token comment">// this creates an array like this:</span>
<span class="token keyword">let</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token punctuation">&#123;</span>
        id<span class="token operator">:</span> <span class="token string">'421'</span><span class="token punctuation">,</span>
        occurrences<span class="token operator">:</span> <span class="token number">3</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token operator">...</span><span class="token punctuation">]</span>
<span class="token punctuation">]</span>

<span class="token comment">// now the keywords need to be sorted based on decending occurences</span>
<span class="token comment">// then we slice the array to the first 3 keywords</span>
<span class="token comment">// after that we map the ids into an string seperated by commas</span>
<span class="token keyword">let</span> keywordString <span class="token operator">=</span> topKeywords<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span> <span class="token operator">=></span> t<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token comment">// this string is being put into the url that we are fetching</span>
<span class="token comment">// as "with_keywords"</span>
<span class="token comment">// this is our final url</span>
<span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span>
	<span class="token template-string"><span class="token template-punctuation string">&#96;</span><span class="token string">https://api.themoviedb.org/3/discover/movie?api_key=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">TMDB_API_KEY</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">&amp;language=en-US&amp;sort_by=popularity.desc&amp;include_adult=false&amp;include_video=false&amp;with_runtime.gte=75&amp;with_keywords=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>keywordString<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">&#96;</span></span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// now we need to filter out the movies that the user already</span>
<span class="token comment">// knows from the results</span>
recommendedMovies <span class="token operator">=</span> recommendedMovies<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span>movie<span class="token operator">:</span> <span class="token punctuation">&#123;</span> id<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token operator">!</span>liked_movies<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span> <span class="token operator">=></span> f<span class="token punctuation">.</span>id <span class="token operator">===</span> movie<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// we also filter out the movies that have less than 100 votes</span>
<span class="token comment">// since the database contains a lot of weird short films</span>
recommendedMovies <span class="token operator">=</span> recommendedMovies<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span>movie<span class="token operator">:</span> <span class="token punctuation">&#123;</span>vote_count<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token operator">=></span> movie<span class="token punctuation">.</span>vote_count <span class="token operator">></span> <span class="token number">100</span><span class="token punctuation">)</span>

<span class="token comment">// that pretty much sums up how you get the individual recommendations</span></code><!-- HTML_TAG_END --></pre>
<hr>
<br>
Commit: <a href="https://github.com/hartmann-jonas/movie-db-two/commit/951a804edac393080bdcddab50066ee9ea9ec0c6" target="_blank">Version 0.2.0</a>
<p>Published: 2023-04-03</p></div>
</article></main>


		<script type="module" data-sveltekit-hydrate="1r3vit9">
			import { start } from "../_app/immutable/start-aca0e6ba.js";

			start({
				env: {},
				paths: {"assets":"","base":""},
				target: document.querySelector('[data-sveltekit-hydrate="1r3vit9"]').parentNode,
				version: "1681738644203",
				hydrate: {
					node_ids: [0, 2, 7],
					data: [null,null,null],
					form: null,
					error: null
				}
			});
		</script>
	</div>
	</body>
	<style>
		body {
			margin: 0;
			padding: 0;
		}
	</style>
</html>
